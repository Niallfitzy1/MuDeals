"use strict";function writeNewPost(e,t,n,a,s,o,l,i,r){var c={author:t,uid:e,title:a,body:s,location:o,lat:l,"long":i,price:r,starCount:0,authorPic:n},d=firebase.database().ref().child("posts").push().key,u={};return u["/posts/"+d]=c,u["/user-posts/"+e+"/"+d]=c,firebase.database().ref().update(u)}function toggleStar(e,t){e.transaction(function(e){return e&&(e.stars&&e.stars[t]?(e.starCount--,e.stars[t]=null):(e.starCount++,e.stars||(e.stars={}),e.stars[t]=!0)),e})}function showNotif(e){var t=document.querySelector(".mdl-js-snackbar");t.MaterialSnackbar.showSnackbar({message:e})}function addMarker(e){for(var t=0;t<e.length;t++){var n=new google.maps.LatLng(e[t].placeLat,e[t].placeLong),a=new google.maps.Marker({draggable:!1,animation:google.maps.Animation.DROP,position:n,map:map}),s="Location: "+e[t].place+"<br><button class='mdl-button--raised mdl-button mdl-js-button mdl-js-ripple-effect' onclick='filterLocation("+e[t].placeLat+","+e[t].placeLong+")'>Filter By Location</button>",o=new google.maps.InfoWindow;google.maps.event.addListener(a,"click",function(e,t,n){return function(){n.setContent(t),n.open(map,e)}}(a,s,o))}}function initMap(){map=new google.maps.Map(document.getElementById("map"),{center:{lat:53.381145,lng:-6.592528},zoom:15}),addMarker(locations)}function filterLocation(e,t){filterSection.getElementsByClassName("posts-container")[0].innerHTML="",filterSection.style.display="";firebase.database().ref("posts").orderByChild("lat").equalTo(e).once("value",function(e){e.forEach(function(e){if(e.val()["long"]==t){var n=e.val().author||"Anonymous",a=filterSection.getElementsByClassName("posts-container")[0];a.insertBefore(createPostElement(e.key,e.val().title,e.val().body,e.val().location,e.val().price,n,e.val().uid,e.val().authorPic),a.firstChild)}})})}function updateLocations(e){locations=[],e.on("value",function(e){e.forEach(function(e){var t={place:e.val().location,placeLat:e.val().lat,placeLong:e.val()["long"]};locations.push(t)})})}function createPostElement(e,t,n,a,s,o,l,i){if(void 0!=currentUID)var r=firebase.auth().currentUser.uid,c='<div class="post-'+e+' mdl-cell mdl-cell--12-col mdl-cell--4-col-tablet mdl-cell--6-col-phone mdl-cell--4-col-desktop mdl-grid mdl-grid--no-spacing"><div class="mdl-card mdl-shadow--2dp"><div class="mdl-card__title"><h4 class="mdl-card__title-text"></h4></div><div class="header"><div><div class="avatar"></div><div class="username mdl-color-text--black"></div></div></div><span class="star"><div class="not-starred material-icons">star_border</div><div class="starred material-icons">star</div><div class="star-count">0</div></span><h5>Deal Info</h5><div class="text"></div><h5>Deal Location</h5><div class="location"></div><h5>Deal Pricing</h5><div class="price"></div><h5>Comments</h5><div class="comments-container"></div><form class="add-comment" action="#"><div class="mdl-textfield mdl-js-textfield"><input class="mdl-textfield__input new-comment" type="text"><label class="mdl-textfield__label">Add Comment...</label></div></form></div></div>';else var c='<div class="post-'+e+' mdl-cell mdl-cell--12-col mdl-cell--4-col-tablet mdl-cell--8-col-phone mdl-cell--4-col-desktop mdl-grid mdl-grid--no-spacing"><div class="mdl-card mdl-shadow--2dp"><div class="mdl-card__title"><h4 class="mdl-card__title-text"></h4></div><div class="header"><div><div class="avatar"></div><div class="username mdl-color-text--black"></div></div></div><span class="star"><div class="not-starred material-icons">star_border</div><div class="star-count">0</div></span><h5>Deal Info</h5><div class="text"></div><h5>Deal Location</h5><div class="location"></div><h5>Deal Pricing</h5><div class="price"></div><h5>Comments</h5><div class="comments-container"></div><form class="add-comment" action="#"><div class="mdl-textfield mdl-js-textfield"><input class="mdl-textfield__input new-comment" type="text"><label class="mdl-textfield__label">Add Comment...</label></div></form></div></div>';var d=document.createElement("div");d.innerHTML=c;var u=d.firstChild;componentHandler&&componentHandler.upgradeElements(u.getElementsByClassName("mdl-textfield")[0]);var m=u.getElementsByClassName("add-comment")[0],p=u.getElementsByClassName("new-comment")[0];if(void 0!=currentUID)var v=u.getElementsByClassName("starred")[0];var g=u.getElementsByClassName("not-starred")[0];u.getElementsByClassName("location")[0].innerText=a,u.getElementsByClassName("price")[0].innerText=s,u.getElementsByClassName("text")[0].innerText=n,u.getElementsByClassName("mdl-card__title-text")[0].innerText=t,u.getElementsByClassName("username")[0].innerText=o||"Anonymous",u.getElementsByClassName("avatar")[0].style.backgroundImage='url("'+(i||"./silhouette.jpg")+'")';var f=firebase.database().ref("post-comments/"+e);f.on("child_added",function(e){addCommentElement(u,e.key,e.val().text,e.val().author)}),f.on("child_changed",function(e){setCommentValues(u,e.key,e.val().text,e.val().author)}),f.on("child_removed",function(e){deleteComment(u,e.key)});var y=firebase.database().ref("posts/"+e+"/starCount");if(y.on("value",function(e){updateStarCount(u,e.val())}),void 0!=currentUID){var B=firebase.database().ref("posts/"+e+"/stars/"+r);B.on("value",function(e){updateStarredByCurrentUser(u,e.val())}),listeningFirebaseRefs.push(B)}listeningFirebaseRefs.push(f),listeningFirebaseRefs.push(y),m.onsubmit=function(t){t.preventDefault(),void 0!=currentUID?(createNewComment(e,firebase.auth().currentUser.displayName,r,p.value),p.value="",p.parentElement.MaterialTextfield.boundUpdateClassesHandler()):showNotif("Please login to comment.")};var h=function(){if(void 0!=currentUID){var t=firebase.database().ref("/posts/"+e),n=firebase.database().ref("/user-posts/"+l+"/"+e);toggleStar(t,r),toggleStar(n,r)}else showNotif("Please login to vote.")};return g.onclick=h,void 0!=currentUID&&(v.onclick=h),u}function createNewComment(e,t,n,a){firebase.database().ref("post-comments/"+e).push({text:a,author:t,uid:n})}function updateStarredByCurrentUser(e,t){t?(e.getElementsByClassName("starred")[0].style.display="inline-block",e.getElementsByClassName("not-starred")[0].style.display="none"):(e.getElementsByClassName("starred")[0].style.display="none",e.getElementsByClassName("not-starred")[0].style.display="inline-block")}function updateStarCount(e,t){e.getElementsByClassName("star-count")[0].innerText=t}function addCommentElement(e,t,n,a){var s=document.createElement("div");s.classList.add("comment-"+t),s.innerHTML='<span class="username"></span><span class="comment"></span>',s.getElementsByClassName("comment")[0].innerText=n,s.getElementsByClassName("username")[0].innerText=a||"Anonymous";var o=e.getElementsByClassName("comments-container")[0];o.appendChild(s)}function setCommentValues(e,t,n,a){var s=e.getElementsByClassName("comment-"+t)[0];s.getElementsByClassName("comment")[0].innerText=n,s.getElementsByClassName("fp-username")[0].innerText=a}function deleteComment(e,t){var n=e.getElementsByClassName("comment-"+t)[0];n.parentElement.removeChild(n)}function startDatabaseQueries(){function o(e,t){e.on("child_added",function(e){var n=e.val().author||"Anonymous",a=t.getElementsByClassName("posts-container")[0];a.insertBefore(createPostElement(e.key,e.val().title,e.val().body,e.val().location,e.val().price,n,e.val().uid,e.val().authorPic),a.firstChild)}),e.on("child_changed",function(e){var n=t.getElementsByClassName("posts-container")[0],a=n.getElementsByClassName("post-"+e.key)[0];a.getElementsByClassName("mdl-card__title-text")[0].innerText=e.val().title,a.getElementsByClassName("username")[0].innerText=e.val().author,a.getElementsByClassName("location")[0].innerText=e.val().location,a.getElementsByClassName("price")[0].innerText=e.val().price,a.getElementsByClassName("text")[0].innerText=e.val().body,a.getElementsByClassName("star-count")[0].innerText=e.val().starCount}),e.on("child_removed",function(e){var n=t.getElementsByClassName("posts-container")[0],a=n.getElementsByClassName("post-"+e.key)[0];a.parentElement.removeChild(a)})}if(void 0!=currentUID)var e=firebase.auth().currentUser.uid,t=firebase.database().ref("user-posts/"+e);var n=firebase.database().ref("posts").orderByChild("starCount"),a=firebase.database().ref("posts").orderByChild("location"),s=firebase.database().ref("posts").limitToLast(100);o(n,topPostsSection),o(a,locationSection),o(s,recentPostsSection),void 0!=currentUID&&o(t,userPostsSection),updateLocations(a),listeningFirebaseRefs.push(n),listeningFirebaseRefs.push(s),void 0!=currentUID&&listeningFirebaseRefs.push(t),listeningFirebaseRefs.push(a)}function writeUserData(e,t,n,a){firebase.database().ref("users/"+e).set({username:t,email:n,profile_picture:a})}function cleanupUi(){topPostsSection.getElementsByClassName("posts-container")[0].innerHTML="",filterSection.getElementsByClassName("posts-container")[0].innerHTML="",filterSection.style.display="none",recentPostsSection.getElementsByClassName("posts-container")[0].innerHTML="",userPostsSection.getElementsByClassName("posts-container")[0].innerHTML="",locationSection.getElementsByClassName("posts-container")[0].innerHTML="",listeningFirebaseRefs.forEach(function(e){e.off()}),listeningFirebaseRefs=[]}function onAuthStateChanged(e){e&&currentUID===e.uid||(cleanupUi(),e?(signInButton.style.display="none",signOutButton.style.display="",myPostsMenuButton.style.display="",addButton.style.display="",currentUID=e.uid,writeUserData(e.uid,e.displayName,e.email,e.photoURL),startDatabaseQueries()):(myPostsMenuButton.style.display="none",addButton.style.display="none",signOutButton.style.display="none",signInButton.style.display="",currentUID=void 0,startDatabaseQueries(),showNotif("Please login to post, vote or comment.")))}function newPostForCurrentUser(e,t,n,a,s,o){var l=firebase.auth().currentUser.uid;return firebase.database().ref("/users/"+l).once("value").then(function(l){var i=l.val().username;return writeNewPost(firebase.auth().currentUser.uid,i,firebase.auth().currentUser.photoURL,e,t,n,a,s,o)})}function showSection(e,t){recentPostsSection.style.display="none",userPostsSection.style.display="none",topPostsSection.style.display="none",locationSectionContainer.style.display="none",filterSection.style.display="none",aboutSection.style.display="none",contactSection.style.display="none",addPost.style.display="none",recentMenuButton.classList.remove("is-active"),myPostsMenuButton.classList.remove("is-active"),topPostsMenuButton.classList.remove("is-active"),locationMenuButton.classList.remove("is-active"),aboutMenuButton.classList.remove("is-active"),contactMenuButton.classList.remove("is-active"),e&&(e.style.display="block"),t&&t.classList.add("is-active")}var messageForm=document.getElementById("message-form"),messageInput=document.getElementById("new-post-message"),titleInput=document.getElementById("new-post-title"),locationInput=document.getElementById("new-post-location"),priceInput=document.getElementById("new-post-price"),signInButton=document.getElementById("sign-in-button"),signOutButton=document.getElementById("sign-out-button"),addPost=document.getElementById("add-post"),addButton=document.getElementById("add"),recentPostsSection=document.getElementById("recent-posts-list"),userPostsSection=document.getElementById("user-posts-list"),topPostsSection=document.getElementById("top-posts-list"),locationSectionContainer=document.getElementById("location-posts-list"),locationSection=document.getElementById("location-posts-list-content"),filterSection=document.getElementById("location-filter-list"),recentMenuButton=document.getElementById("menu-recent"),myPostsMenuButton=document.getElementById("menu-my-posts"),locationMenuButton=document.getElementById("menu-location-posts"),topPostsMenuButton=document.getElementById("menu-top-posts"),listeningFirebaseRefs=[],aboutMenuButton=document.getElementById("menu-about"),aboutSection=document.getElementById("about"),contactMenuButton=document.getElementById("menu-contact"),contactSection=document.getElementById("contact"),map,clickMarker,clickLat,clickLng,locations=[],existTitle,currentUID;window.addEventListener("load",function(){signInButton.addEventListener("click",function(){var e=new firebase.auth.GoogleAuthProvider;firebase.auth().signInWithPopup(e)}),signOutButton.addEventListener("click",function(){firebase.auth().signOut()}),firebase.auth().onAuthStateChanged(onAuthStateChanged),messageForm.onsubmit=function(e){e.preventDefault();var t=messageInput.value,n=titleInput.value,a=locationInput.value,s=priceInput.value;t&&n&&a&&s&&""!=clickLat&&""!=clickLng?(newPostForCurrentUser(n,t,a,clickLat,clickLng,s).then(function(){myPostsMenuButton.click()}),messageInput.value="",titleInput.value="",locationInput.value="",priceInput.value="",clickLat="",clickLng=""):showNotif("Error with submission. Please fill out all fields and click a location.")},recentMenuButton.onclick=function(){showSection(recentPostsSection,recentMenuButton)},myPostsMenuButton.onclick=function(){showSection(userPostsSection,myPostsMenuButton)},topPostsMenuButton.onclick=function(){showSection(topPostsSection,topPostsMenuButton)},locationMenuButton.onclick=function(){showSection(locationSectionContainer,locationMenuButton),initMap()},aboutMenuButton.onclick=function(){showSection(aboutSection,aboutMenuButton)},contactMenuButton.onclick=function(){showSection(contactSection,contactMenuButton)},addButton.onclick=function(){function l(e){clickMarker?(clickMarker.setMap(map),clickMarker.setPosition(e)):clickMarker=new google.maps.Marker({position:e,map:map})}showSection(addPost),messageInput.value="",titleInput.value="",locationInput.value="",document.getElementById("locationIn").style.display="none",priceInput.value="",clickLat="",clickLng="",existTitle="";var e=[{featureType:"poi",elementType:"labels",stylers:[{visibility:"off"}]}],t={zoom:15,center:{lat:53.381145,lng:-6.592528},mapTypeControl:!0,navigationControlOptions:{style:google.maps.NavigationControlStyle.SMALL},mapTypeId:google.maps.MapTypeId.ROADMAP,styles:e};map=new google.maps.Map(document.getElementById("mapContainer"),t);var n=new google.maps.LatLngBounds(new google.maps.LatLng(53.37405,-6.608216),new google.maps.LatLng(53.390361,-6.5851));google.maps.event.addListener(map,"dragend",function(){if(!n.contains(map.getCenter())){var e=map.getCenter(),t=e.lng(),a=e.lat(),s=n.getNorthEast().lng(),o=n.getNorthEast().lat(),l=n.getSouthWest().lng(),i=n.getSouthWest().lat();l>t&&(t=l),t>s&&(t=s),i>a&&(a=i),a>o&&(a=o),map.setCenter(new google.maps.LatLng(a,t))}});for(var a=0;a<locations.length;a++){var s=new google.maps.LatLng(locations[a].placeLat,locations[a].placeLong),o=new google.maps.Marker({draggable:!1,animation:google.maps.Animation.DROP,position:s,map:map,title:locations[a].place,label:{color:"gray",fontWeight:"bold",text:locations[a].place},icon:{labelOrigin:new google.maps.Point(11,50),url:"marker_red.png",size:new google.maps.Size(22,40),origin:new google.maps.Point(0,0),anchor:new google.maps.Point(11,40)}});google.maps.event.addListener(o,"click",function(e){return function(){clickLat=e.getPosition().lat(),clickLng=e.getPosition().lng(),document.forms["message-form"].elements["new-post-location"].value=e.getTitle(),document.getElementById("locationIn").style.display="none",clickMarker.setMap(null)}}(o))}google.maps.event.addListener(map,"click",function(e){l(e.latLng),clickLat=e.latLng.lat(),clickLng=e.latLng.lng(),document.getElementById("locationIn").style.display="",locationInput.value=""})},recentMenuButton.onclick()},!1);